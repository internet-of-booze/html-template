<!DOCTYPE html>
<html dir="ltr" lang="en"><head>
  <meta charset="utf-8">
  <title>IOB: Xmas Torching</title>

  <link rel="stylesheet" href="../css/normalize.css">
  <link rel="stylesheet" href="../css/main.css">
  <link href="https://fonts.googleapis.com/css?family=Lato:300,400,900" rel="stylesheet">
  <style>
	html, body {
		overflow: auto;
	}
  </style>

  <meta http-equiv="origin-trial" data-feature="WebUSB (For Chrome M57+)" data-expires="2017-06-19" content="Ag83MurQOa5N4SKRCqqtSlbycfe08s5LgUiqEI7J3jTk2NEIpRp7SLPz2i+EBDuXyf+AeRMdD6BI++kTSJmGzQEAAABReyJvcmlnaW4iOiJodHRwczovL3dlYnVzYi5naXRodWIuaW86NDQzIiwiZmVhdHVyZSI6IldlYlVTQjIiLCJleHBpcnkiOjE0OTc4OTM2OTV9">

</head>

<body class="control">
	<section class="social">
		<a class="applink" href="https://xmas.mostlypainless.com">xmas.mostlypainless.com</a>
		<div class="scan-it">
			<p>QR Scanner Enabled</p>
			<img class="qr-code" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAK8AAACvAQMAAACxXBw2AAAABlBMVEX///8uLi6wwLx3AAAACXBIWXMAAA7EAAAOxAGVKw4bAAABGklEQVRIx+2WQa7DIAxEzYolN4KbNcnN4EYss8LfY9Kmzd6O1F9HVqK3Qp4ZB6JffX9FlqqUKaeR8L3a4yrdeBAJFpQcsKDYOlHolDYeN+Oa8AxPLC2wemGVoWfFV3V8MXwHjL5Y0whrhV566PkaNyMcRfc4KDDjJH3p9pgK81646QDOed+CdygfFG/ydsBBT8LHTE5l7LBKMKio1RDv9TY896tMRBf7+yqwwiJDloCr8WUuDwcc206EaBeuUP6ZBn9MAQeUrdZgCszHHs81kxP+3mL6tJrjY5ki3rDaxg64auv+RupuxPPPPeaOO2dijbFKkbblpbw5FrPhckbLW9L88XFZmBK8jGmKpwcJlzN6UPi0pgn+1b+sP9UEcOx6Wpr+AAAAAElFTkSuQmCC" />
		</div>
	</section>

	<section class="admin-panel">
		<div class="inputs">
      <div class="action">
        <button class="btn btn-primary" id="connect">Connect</button> <span id="status"></span>
      </div>
			<h2>Manual Input ranges</h2>
			<div class="form-item">
				<label for="red">Arm Angle</label>
				<input type="range" min="0" max="255" value="0" id="red"/>
			</div>
			<div class="form-item">
				<label for="green">Pump Power</label>

				<input type="range" min="0" max="255" value="0" id="green"/>
			</div>
			<div class="form-item">
				<label for="blue">Nothing</label>

				<input type="range" min="0" max="255" value="0" id="blue"/>
			</div>
	</section>
	<section class="totals">
		<div class="total votes">Total Votes: <i>0</i></div>
		<div class="total fireballs">Fireballs: <i>0</i></div>
		<h3>The last 6 fireballs</h2>

      <div class="fireball-table">
        <ul class="fireballers">

        </ul>
      </div>
    </section>

    <section class="votes panel">
		<h2>Current Voting Pool</h2>
		<p>Please cast your vote! You will see your name on your application. The winner will cause a <span class="fireball">Fireball</span>!</p>

		<div class="vote-table">
			<ul class="voters">

			</ul>
		</div>
	</section>


	<script src="../js/vendor/modernizr-3.6.0.min.js"></script>
     <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
     <script>window.jQuery || document.write('<script src="js/vendor/jquery-3.3.1.min.js"><\/script>')</script>

	<script src="https://www.gstatic.com/firebasejs/5.7.0/firebase.js"></script>
	<script src="../js/plugins.js"></script>

	<script src="../js/main.js"></script>

	<script>
	heatr.start();
	heatr.instance.system = {
		last_vote : 0
	};
	heatr.instance.config = {
		timeout : 3000
	};
	heatr.instance.voters = {};
	heatr.instance.fireballs = {};
	heatr.instance.pull_vote = true;

	heatr.snapshots = {
		queuer : function(queue) {

			$('.total.votes i').html(queue.size);
			let rows = queue;

			rows.forEach(function(doc) {
				let data = doc.data();

				// split up the results //
				(data.fireball ? heatr.template.rower(data, 'fireballs') : heatr.template.rower(data));
			});

			heatr.vote.go();
		}
		, system : function(config) {
			// every time a system config is added we should scope it to our heatr class //
			config.forEach(function(conf) {
				let data = conf.data();
				console.log(data);
				// heatr.instance.system
			});
		}
	};

	heatr.vote = {
		votes : []
		, fireballs : []
		, check : function() {
			let system = heatr.instance.system;
			// check if we need to run the vote //
			console.log('Checking votes...', heatr.vote.votes);
			if(system.last_vote && system.last_vote > 0) {
				// the system has already made a vote //
				// check if the timeout is over //

				return false;
			}

			return true;
		}
		, pull : function() {

		}
		, go : function() {
			// lets run the whole check and vote process together //
			let check = heatr.vote.check()
			voters = heatr.instance.voters;

			if(check) {
				// we can run the vote! //
				// get a random voter from our primary voters list and set them to fireball = true so they automagically move to the fireballs //
				let i = heatr.g.rand(Object.keys(voters).length);
				console.log('Voters', heatr.instance.voters, i);
				// heatr.db.collection('voters').where('uid', '==', vote.uid);

			}
		}
	};

	heatr.template.rower = function(item, type) {
		if(typeof type === 'undefined') {
			type = 'voters';
		}

		let displayed = heatr.instance[type]
		, uid = item.user_uid + '__' + item.timestamp
		, target = $('.votes').find('.voters')
		, output = '<li class="vote" id="' + item.user_uid + '__' + item.timestamp + '">';
			if(type === 'fireball') {
				target = $('.fireballs').find('.fireballers');
			}
			output+= '<div class="cell username">' + item.username + '</div>';
			output+= '<div class="cell time">' + item.timestamp + '</div>'
		output+= '</li>';

		if(typeof displayed[uid] === 'undefined') {
			$(target).prepend(output);
			heatr.instance[type][uid] = true;
		}

		// lets do some hooking for each type //
		switch(type){
			case 'fireball':
				heatr.vote.fireballs.push(item);
			break;
			case 'voters':
				heatr.vote.votes.push(item);
			break;
		}

	};

	heatr.system = {
		init : function() {
			// we need to add in our system settings if they are not there //
			console.log('heater db', heatr.db);

		}
		, install : function() {

			heatr.db.collection("system").add(system)
			.then(function(docRef) {
			    console.log("Document written with ID: ", docRef.id);
			})
			.catch(function(error) {
			    console.error("Error adding document: ", error);
			});
		}
	}

	heatr.intervals = {
		select : function() {
			// select a vote to be our fireball //

		}
	};

	let vote_queue = {}
	, fireballs = {};

	// lets create our base system configs //
	heatr.system.init();

	heatr.db.collection("queue").orderBy("timestamp", 'asc').onSnapshot(heatr.snapshots.queuer);

	heatr.db.collection("system").onSnapshot(heatr.snapshots.system);
	</script>


	<script src="js/serial.js"></script>
	<script src="js/rgb.js"></script>

</body>
</html>
